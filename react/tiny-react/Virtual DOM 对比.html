<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>9 Virtual DOM 对比 | 学习笔记</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="高级前端开发工程师进阶之路">
    
    <link rel="preload" href="/learn-note/assets/css/0.styles.a015446e.css" as="style"><link rel="preload" href="/learn-note/assets/js/app.e5c60dd5.js" as="script"><link rel="preload" href="/learn-note/assets/js/2.923ebc4c.js" as="script"><link rel="preload" href="/learn-note/assets/js/6.28078a48.js" as="script"><link rel="prefetch" href="/learn-note/assets/js/10.cc2c2ceb.js"><link rel="prefetch" href="/learn-note/assets/js/11.f0324971.js"><link rel="prefetch" href="/learn-note/assets/js/12.dc10d3cb.js"><link rel="prefetch" href="/learn-note/assets/js/13.d8c503cc.js"><link rel="prefetch" href="/learn-note/assets/js/14.429c3506.js"><link rel="prefetch" href="/learn-note/assets/js/15.279cfa1a.js"><link rel="prefetch" href="/learn-note/assets/js/16.9e242dd8.js"><link rel="prefetch" href="/learn-note/assets/js/17.4600f18e.js"><link rel="prefetch" href="/learn-note/assets/js/18.3e03703e.js"><link rel="prefetch" href="/learn-note/assets/js/19.14c2ff87.js"><link rel="prefetch" href="/learn-note/assets/js/20.9e01244f.js"><link rel="prefetch" href="/learn-note/assets/js/21.f6b65b4f.js"><link rel="prefetch" href="/learn-note/assets/js/22.6536e49d.js"><link rel="prefetch" href="/learn-note/assets/js/23.04c00470.js"><link rel="prefetch" href="/learn-note/assets/js/24.e2c9a0db.js"><link rel="prefetch" href="/learn-note/assets/js/25.6812848b.js"><link rel="prefetch" href="/learn-note/assets/js/26.cd916bb8.js"><link rel="prefetch" href="/learn-note/assets/js/27.2fb5de3b.js"><link rel="prefetch" href="/learn-note/assets/js/28.afe27182.js"><link rel="prefetch" href="/learn-note/assets/js/29.e962b705.js"><link rel="prefetch" href="/learn-note/assets/js/3.603891ed.js"><link rel="prefetch" href="/learn-note/assets/js/30.ead0d726.js"><link rel="prefetch" href="/learn-note/assets/js/31.06de26f1.js"><link rel="prefetch" href="/learn-note/assets/js/32.3458a47f.js"><link rel="prefetch" href="/learn-note/assets/js/33.c0bf5f85.js"><link rel="prefetch" href="/learn-note/assets/js/34.4b35481e.js"><link rel="prefetch" href="/learn-note/assets/js/35.3fc426c2.js"><link rel="prefetch" href="/learn-note/assets/js/36.9106058b.js"><link rel="prefetch" href="/learn-note/assets/js/37.5b21f9e6.js"><link rel="prefetch" href="/learn-note/assets/js/38.d294b1ae.js"><link rel="prefetch" href="/learn-note/assets/js/39.838d9388.js"><link rel="prefetch" href="/learn-note/assets/js/4.6adf188e.js"><link rel="prefetch" href="/learn-note/assets/js/40.b52fe856.js"><link rel="prefetch" href="/learn-note/assets/js/41.1fa7d909.js"><link rel="prefetch" href="/learn-note/assets/js/42.1cc55ce2.js"><link rel="prefetch" href="/learn-note/assets/js/43.463a8567.js"><link rel="prefetch" href="/learn-note/assets/js/44.c2e4e54a.js"><link rel="prefetch" href="/learn-note/assets/js/45.c486ea81.js"><link rel="prefetch" href="/learn-note/assets/js/46.69b5b662.js"><link rel="prefetch" href="/learn-note/assets/js/47.0c3cf9bf.js"><link rel="prefetch" href="/learn-note/assets/js/48.6d76cffd.js"><link rel="prefetch" href="/learn-note/assets/js/49.79e133dc.js"><link rel="prefetch" href="/learn-note/assets/js/5.4597eefb.js"><link rel="prefetch" href="/learn-note/assets/js/50.56e78413.js"><link rel="prefetch" href="/learn-note/assets/js/51.b952947f.js"><link rel="prefetch" href="/learn-note/assets/js/52.c5b4edf2.js"><link rel="prefetch" href="/learn-note/assets/js/53.6dd42254.js"><link rel="prefetch" href="/learn-note/assets/js/54.aa1c54c3.js"><link rel="prefetch" href="/learn-note/assets/js/55.cd02cb20.js"><link rel="prefetch" href="/learn-note/assets/js/56.177ab33e.js"><link rel="prefetch" href="/learn-note/assets/js/57.8a468e2a.js"><link rel="prefetch" href="/learn-note/assets/js/58.060b7ee2.js"><link rel="prefetch" href="/learn-note/assets/js/59.64fed891.js"><link rel="prefetch" href="/learn-note/assets/js/60.7c90f2d3.js"><link rel="prefetch" href="/learn-note/assets/js/61.901805ef.js"><link rel="prefetch" href="/learn-note/assets/js/62.e3084252.js"><link rel="prefetch" href="/learn-note/assets/js/63.9adbd0ea.js"><link rel="prefetch" href="/learn-note/assets/js/7.4cc52edf.js"><link rel="prefetch" href="/learn-note/assets/js/8.e1c148ca.js"><link rel="prefetch" href="/learn-note/assets/js/9.8a6b3fa0.js">
    <link rel="stylesheet" href="/learn-note/assets/css/0.styles.a015446e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/learn-note/" class="home-link router-link-active"><!----> <span class="site-name">学习笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/learn-note/react/" class="nav-link router-link-active">
  react
</a></div><div class="nav-item"><a href="/learn-note/vue/" class="nav-link">
  vue
</a></div><div class="nav-item"><a href="/learn-note/nodejs/" class="nav-link">
  nodejs
</a></div><div class="nav-item"><a href="/learn-note/microend/" class="nav-link">
  微前端
</a></div><div class="nav-item"><a href="/learn-note/linux/" class="nav-link">
  linux
</a></div><div class="nav-item"><a href="/learn-note/algorithm/" class="nav-link">
  数据结构与算法
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/learn-note/react/" class="nav-link router-link-active">
  react
</a></div><div class="nav-item"><a href="/learn-note/vue/" class="nav-link">
  vue
</a></div><div class="nav-item"><a href="/learn-note/nodejs/" class="nav-link">
  nodejs
</a></div><div class="nav-item"><a href="/learn-note/microend/" class="nav-link">
  微前端
</a></div><div class="nav-item"><a href="/learn-note/linux/" class="nav-link">
  linux
</a></div><div class="nav-item"><a href="/learn-note/algorithm/" class="nav-link">
  数据结构与算法
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/learn-note/react/tiny-react/" class="sidebar-heading clickable router-link-active open"><span>框架原理</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-note/react/tiny-react/JSX 到底是什么.html" class="sidebar-link">1. JSX 到底是什么</a></li><li><a href="/learn-note/react/tiny-react/DOM 操作问题.html" class="sidebar-link">2. DOM 操作问题</a></li><li><a href="/learn-note/react/tiny-react/什么是 Virtual DOM.html" class="sidebar-link">3. 什么是 Virtual DOM</a></li><li><a href="/learn-note/react/tiny-react/Virtual DOM 如何提升效率.html" class="sidebar-link">4. Virtual DOM 如何提升效率</a></li><li><a href="/learn-note/react/tiny-react/创建 Virtual DOM.html" class="sidebar-link">5. 创建 Virtual DOM</a></li><li><a href="/learn-note/react/tiny-react/渲染 Virtual DOM 对象为 DOM 对象.html" class="sidebar-link">6. 渲染 Virtual DOM 对象为 DOM 对象</a></li><li><a href="/learn-note/react/tiny-react/为元素节点添加属性.html" class="sidebar-link">7. 为元素节点添加属性</a></li><li><a href="/learn-note/react/tiny-react/渲染组件.html" class="sidebar-link">8. 渲染组件</a></li><li><a href="/learn-note/react/tiny-react/Virtual DOM 对比.html" class="active sidebar-link">9 Virtual DOM 对比</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/learn-note/react/tiny-react/Virtual DOM 对比.html#_9-1-virtual-dom-类型相同" class="sidebar-link">9.1 Virtual DOM 类型相同</a></li><li class="sidebar-sub-header"><a href="/learn-note/react/tiny-react/Virtual DOM 对比.html#_9-2-virtual-dom-类型不同" class="sidebar-link">9.2 Virtual DOM 类型不同</a></li><li class="sidebar-sub-header"><a href="/learn-note/react/tiny-react/Virtual DOM 对比.html#_9-3-删除节点" class="sidebar-link">9.3 删除节点</a></li><li class="sidebar-sub-header"><a href="/learn-note/react/tiny-react/Virtual DOM 对比.html#_9-4-类组件状态更新" class="sidebar-link">9.4 类组件状态更新</a></li><li class="sidebar-sub-header"><a href="/learn-note/react/tiny-react/Virtual DOM 对比.html#_9-5-组件更新" class="sidebar-link">9.5 组件更新</a></li></ul></li><li><a href="/learn-note/react/tiny-react/ref 属性.html" class="sidebar-link">10. ref 属性</a></li><li><a href="/learn-note/react/tiny-react/key 属性.html" class="sidebar-link">11. key 属性</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/learn-note/react/hooks/" class="sidebar-heading clickable"><span>hooks</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/learn-note/react/style/" class="sidebar-heading clickable"><span>样式篇</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_9-virtual-dom-对比"><a href="#_9-virtual-dom-对比" class="header-anchor">#</a> 9 Virtual DOM 对比</h1> <h2 id="_9-1-virtual-dom-类型相同"><a href="#_9-1-virtual-dom-类型相同" class="header-anchor">#</a> 9.1 Virtual DOM 类型相同</h2> <p>Virtual DOM 类型相同，如果是元素节点，就对比元素节点属性是否发生变化，如果是文本节点就对比文本节点内容是否发生变化</p> <p>要实现对比，需要先从已存在 DOM 对象中获取其对应的 Virtual DOM 对象。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// diff.js</span>
<span class="token comment">// 获取未更新前的 Virtual DOM</span>
<span class="token keyword">const</span> oldVirtualDOM <span class="token operator">=</span> oldDOM <span class="token operator">&amp;&amp;</span> oldDOM<span class="token punctuation">.</span>_virtualDOM<span class="token punctuation">;</span>
</code></pre></div><p>判断 oldVirtualDOM 是否存在， 如果存在则继续判断要对比的 Virtual DOM 类型是否相同，如果类型相同判断节点类型是否是文本，如果是文本节点对比，就调用 updateTextNode 方法，如果是元素节点对比就调用 setAttributeForElement 方法</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// diff.js</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVirtualDOM <span class="token operator">&amp;&amp;</span> virtualDOM<span class="token punctuation">.</span>type <span class="token operator">===</span> oldVirtualDOM<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>virtualDOM<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 文本节点 对比文本内容是否发生变化</span>
    <span class="token function">updateTextNode</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">,</span> oldVirtualDOM<span class="token punctuation">,</span> oldDOM<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 元素节点 对比元素属性是否发生变化</span>
    <span class="token function">setAttributeForElement</span><span class="token punctuation">(</span>oldDOM<span class="token punctuation">,</span> virtualDOM<span class="token punctuation">,</span> oldVirtualDOM<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>updateTextNode 方法用于对比文本节点内容是否发生变化，如果发生变化则更新真实 DOM 对象中的内容，既然真实 DOM 对象发生了变化，还要将最新的 Virtual DOM 同步给真实 DOM 对象。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">updateTextNode</span><span class="token punctuation">(</span><span class="token parameter">virtualDOM<span class="token punctuation">,</span> oldVirtualDOM<span class="token punctuation">,</span> oldDOM</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果文本节点内容不同</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>virtualDOM<span class="token punctuation">.</span>props<span class="token punctuation">.</span>textContent <span class="token operator">!==</span> oldVirtualDOM<span class="token punctuation">.</span>props<span class="token punctuation">.</span>textContent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 更新真实 DOM 对象中的内容</span>
    oldDOM<span class="token punctuation">.</span>textContent <span class="token operator">=</span> virtualDOM<span class="token punctuation">.</span>props<span class="token punctuation">.</span>textContent<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 同步真实 DOM 对应的 Virtual DOM</span>
  oldDOM<span class="token punctuation">.</span>_virtualDOM <span class="token operator">=</span> virtualDOM<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>setAttributeForElement 方法用于设置/更新元素节点属性</p> <p>思路是先分别获取更新后的和更新前的 Virtual DOM 中的 props 属性，循环新 Virtual DOM 中的 props 属性，通过对比看一下新 Virtual DOM 中的属性值是否发生了变化，如果发生变化 需要将变化的值更新到真实 DOM 对象中</p> <p>再循环未更新前的 Virtual DOM 对象，通过对比看看新的 Virtual DOM 中是否有被删除的属性，如果存在删除的属性 需要将 DOM 对象中对应的属性也删除掉</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// updateNodeElement.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">updateNodeElement</span><span class="token punctuation">(</span>
  <span class="token parameter">newElement<span class="token punctuation">,</span>
  virtualDOM<span class="token punctuation">,</span>
  oldVirtualDOM <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取节点对应的属性对象</span>
  <span class="token keyword">const</span> newProps <span class="token operator">=</span> virtualDOM<span class="token punctuation">.</span>props <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> oldProps <span class="token operator">=</span> oldVirtualDOM<span class="token punctuation">.</span>props <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>newProps<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">propName</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取属性值</span>
    <span class="token keyword">const</span> newPropsValue <span class="token operator">=</span> newProps<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> oldPropsValue <span class="token operator">=</span> oldProps<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newPropsValue <span class="token operator">!==</span> oldPropsValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 判断属性是否是否事件属性 onClick -&gt; click</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>propName<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&quot;on&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 事件名称</span>
        <span class="token keyword">const</span> eventName <span class="token operator">=</span> propName<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 为元素添加事件</span>
        newElement<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>eventName<span class="token punctuation">,</span> newPropsValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 删除原有的事件的事件处理函数</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldPropsValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          newElement<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span>eventName<span class="token punctuation">,</span> oldPropsValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>propName <span class="token operator">===</span> <span class="token string">&quot;value&quot;</span> <span class="token operator">||</span> propName <span class="token operator">===</span> <span class="token string">&quot;checked&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        newElement<span class="token punctuation">[</span>propName<span class="token punctuation">]</span> <span class="token operator">=</span> newPropsValue<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>propName <span class="token operator">!==</span> <span class="token string">&quot;children&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>propName <span class="token operator">===</span> <span class="token string">&quot;className&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          newElement<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;class&quot;</span><span class="token punctuation">,</span> newPropsValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          newElement<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>propName<span class="token punctuation">,</span> newPropsValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 判断属性被删除的情况</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>oldProps<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">propName</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> newPropsValue <span class="token operator">=</span> newProps<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> oldPropsValue <span class="token operator">=</span> oldProps<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>newPropsValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 属性被删除了</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>propName<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&quot;on&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> eventName <span class="token operator">=</span> propName<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        newElement<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span>eventName<span class="token punctuation">,</span> oldPropsValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>propName <span class="token operator">!==</span> <span class="token string">&quot;children&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        newElement<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span>propName<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>以上对比的仅仅是最上层元素，上层元素对比完成以后还需要递归对比子元素</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVirtualDOM <span class="token operator">&amp;&amp;</span> virtualDOM<span class="token punctuation">.</span>type <span class="token operator">===</span> oldVirtualDOM<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 递归对比 Virtual DOM 的子元素</span>
    virtualDOM<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">child<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">diff</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> oldDOM<span class="token punctuation">,</span> oldDOM<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><img src="data:image/png;base64,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"> <h2 id="_9-2-virtual-dom-类型不同"><a href="#_9-2-virtual-dom-类型不同" class="header-anchor">#</a> 9.2 Virtual DOM 类型不同</h2> <p>当对比的元素节点类型不同时，就不需要继续对比了，直接使用新的 Virtual DOM 创建 DOM 对象，用新的 DOM 对象直接替换旧的 DOM 对象。当前这种情况要将组件刨除，组件要被单独处理。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// diff.js</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
  <span class="token comment">// 如果 Virtual DOM 类型不一样</span>
  virtualDOM<span class="token punctuation">.</span>type <span class="token operator">!==</span> oldVirtualDOM<span class="token punctuation">.</span>type <span class="token operator">&amp;&amp;</span>
  <span class="token comment">// 并且 Virtual DOM 不是组件 因为组件要单独进行处理</span>
  <span class="token keyword">typeof</span> virtualDOM<span class="token punctuation">.</span>type <span class="token operator">!==</span> <span class="token string">&quot;function&quot;</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 根据 Virtual DOM 创建真实 DOM 元素</span>
  <span class="token keyword">const</span> newDOMElement <span class="token operator">=</span> <span class="token function">createDOMElement</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">)</span>
  <span class="token comment">// 用创建出来的真实 DOM 元素 替换旧的 DOM 元素</span>
  oldDOM<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>newDOMElement<span class="token punctuation">,</span> oldDOM<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_9-3-删除节点"><a href="#_9-3-删除节点" class="header-anchor">#</a> 9.3 删除节点</h2> <p>删除节点发生在节点更新以后并且发生在同一个父节点下的所有子节点身上。</p> <p>在节点更新完成以后，如果旧节点对象的数量多于新 VirtualDOM 节点的数量，就说明有节点需要被删除。</p> <img src="/learn-note/assets/img/5.7929af0a.png" width="40%" align="left"> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 获取就节点的数量</span>
<span class="token keyword">let</span> oldChildNodes <span class="token operator">=</span> oldDOM<span class="token punctuation">.</span>childNodes<span class="token punctuation">;</span>
<span class="token comment">// 如果旧节点的数量多于要渲染的新节点的长度</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>oldChildNodes<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> virtualDOM<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>
    <span class="token keyword">let</span> i <span class="token operator">=</span> oldChildNodes<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    i <span class="token operator">&gt;</span> virtualDOM<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    i<span class="token operator">--</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    oldDOM<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>oldChildNodes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_9-4-类组件状态更新"><a href="#_9-4-类组件状态更新" class="header-anchor">#</a> 9.4 类组件状态更新</h2> <p>以下代码是要更新状态的类组件，在类组件的 state 对象中有默认的 title 状态，点击 change title 按钮调用 handleChange 方法，在 handleChange 方法中调用 this.setState 方法更改 title 的状态值。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Alert</span> <span class="token keyword">extends</span> <span class="token class-name">TinyReact<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">&quot;default title&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 更改 handleChange 方法中的 this 指向 让 this 指向类实例对象</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>handleChange <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleChange</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">handleChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 调用父类中的 setState 方法更改状态</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">&quot;changed title&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>h2<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>title<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>h2<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>message<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleChange<span class="token punctuation">}</span><span class="token operator">&gt;</span>change title<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>setState 方法是定义在父类 Component 中的，该方法的作用是更改子类的 state，产生一个全新的 state 对象。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// Component.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">=</span> props<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// setState 方法被子类调用 此处this指向子类实例对象</span>
    <span class="token comment">// 所以改变的是子类的 state 对象</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>现在子类已经可以调用父类的 setState 方法更改状态值了，当组件的 state 对象发生更改时，要调用 render 方法更新组件视图。</p> <p>在更新组件之前，要使用更新的 Virtual DOM 对象和未更新的 Virtual DOM 进行对比找出更新的部分，达到 DOM 最小化操作的目的。</p> <p>在 setState 方法中可以通过调用 this.render 方法获取更新后的 Virtual DOM，由于 setState 方法被子类调用，this 指向子类，所以此处调用的是子类的 render 方法。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// Component.js</span>
<span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// setState 方法被子类调用 此处this指向子类</span>
  <span class="token comment">// 所以改变的是子类的 state</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">,</span> state<span class="token punctuation">)</span>
  <span class="token comment">// 通过调用 render 方法获取最新的 Virtual DOM</span>
  <span class="token keyword">let</span> virtualDOM <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>要实现对比，还需要获取未更新前的 Virtual DOM，按照之前的经验，我们可以从 DOM 对象中获取其对应的 Virtual DOM 对象，未更新前的 DOM 对象实际上就是现在在页面中显示的 DOM 对象，我们只要能获取到这个 DOM 对象就可以获取到其对应的 Virtual DOM 对象了。</p> <p>页面中的 DOM 对象要怎样获取呢？页面中的 DOM 对象是通过 mountNativeElement 方法挂载到页面中的，所以我们只需要在这个方法中调用 Component 类中的方法就可以将 DOM 对象保存在 Component 类中了。在子类调用 setState 方法的时候，在 setState 方法中再调用另一个获取 DOM 对象的方法就可以获取到之前保存的 DOM 对象了。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// Component.js</span>
<span class="token comment">// 保存 DOM 对象的方法</span>
<span class="token function">setDOM</span><span class="token punctuation">(</span><span class="token parameter">dom</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_dom <span class="token operator">=</span> dom
<span class="token punctuation">}</span>
<span class="token comment">// 获取 DOM 对象的方法</span>
<span class="token function">getDOM</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_dom
<span class="token punctuation">}</span>
</code></pre></div><p>接下来我们要研究一下在 mountNativeElement 方法中如何才能调用到 setDOM 方法，要调用 setDOM 方法，必须要得到类的实例对象，所以目前的问题就是如何在 mountNativeElement 方法中得到类的实例对象，这个类指的不是 Component 类，因为我们在代码中并不是直接实例化的 Component 类，而是实例化的它的子类，由于子类继承了父类，所以在子类的实例对象中也是可以调用到 setDOM 方法的。</p> <p>mountNativeElement 方法接收最新的 Virtual DOM 对象，如果这个 Virtual DOM 对象是类组件产生的，在产生这个 Virtual DOM 对象时一定会先得到这个类的实例对象，然后再调用实例对象下面的 render 方法进行获取。我们可以在那个时候将类组件实例对象添加到 Virtual DOM 对象的属性中，而这个 Virtual DOM 对象最终会传递给 mountNativeElement 方法，这样我们就可以在 mountNativeElement 方法中获取到组件的实例对象了，既然类组件的实例对象获取到了，我们就可以调用 setDOM 方法了。</p> <p>在 buildClassComponent 方法中为 Virtual DOM 对象添加 component 属性， 值为类组件的实例对象。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">buildClassComponent</span><span class="token punctuation">(</span><span class="token parameter">virtualDOM</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> component <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">virtualDOM<span class="token punctuation">.</span>type</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> nextVirtualDOM <span class="token operator">=</span> component<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  nextVirtualDOM<span class="token punctuation">.</span>component <span class="token operator">=</span> component<span class="token punctuation">;</span>
  <span class="token keyword">return</span> nextVirtualDOM<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在 mountNativeElement 方法中获取组件实例对象，通过实例调用调用 setDOM 方法保存 DOM 对象，方便在对比时通过它获取它的 Virtual DOM 对象</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">mountNativeElement</span><span class="token punctuation">(</span><span class="token parameter">virtualDOM<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取组件实例对象</span>
  <span class="token keyword">const</span> component <span class="token operator">=</span> virtualDOM<span class="token punctuation">.</span>component<span class="token punctuation">;</span>
  <span class="token comment">// 如果组件实例对象存在</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>component<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 保存 DOM 对象</span>
    component<span class="token punctuation">.</span><span class="token function">setDOM</span><span class="token punctuation">(</span>newElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>接下来在 setState 方法中就可以调用 getDOM 方法获取 DOM 对象了</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">,</span> state<span class="token punctuation">)</span>
  <span class="token keyword">let</span> virtualDOM <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 获取页面中正在显示的 DOM 对象 通过它可以获取其对象的 Virtual DOM 对象</span>
  <span class="token keyword">let</span> oldDOM <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDOM</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>现在更新前的 Virtual DOM 对象和更新后的 Virtual DOM 对象就都已经获取到了，接下来还要获取到真实 DOM 对象父级容器对象，因为在调用 diff 方法进行对比的时候需要用到</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">,</span> state<span class="token punctuation">)</span>
  <span class="token keyword">let</span> virtualDOM <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> oldDOM <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDOM</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 获取真实 DOM 对象父级容器对象</span>
  <span class="token keyword">let</span> container <span class="token operator">=</span> oldDOM<span class="token punctuation">.</span>parentNode
<span class="token punctuation">}</span>
</code></pre></div><p>接下来就可以调用 diff 方法进行比对了，比对后会按照我们之前写好的逻辑进行 DOM 对象更新，我们就可以在页面中看到效果了</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">,</span> state<span class="token punctuation">)</span>
    <span class="token keyword">let</span> virtualDOM <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> oldDOM <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDOM</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> container <span class="token operator">=</span> oldDOM<span class="token punctuation">.</span>parentNode
    <span class="token comment">// 比对</span>
    <span class="token function">diff</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">,</span> container<span class="token punctuation">,</span> oldDOM<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><h2 id="_9-5-组件更新"><a href="#_9-5-组件更新" class="header-anchor">#</a> 9.5 组件更新</h2> <p>在 diff 方法中判断要更新的 Virtual DOM 是否是组件。</p> <p>如果是组件再判断要更新的组件和未更新前的组件是否是同一个组件，如果不是同一个组件就不需要做组件更新操作，直接调用 mountElement 方法将组件返回的 Virtual DOM 添加到页面中。</p> <p>如果是同一个组件，就执行更新组件操作，其实就是将最新的 props 传递到组件中，再调用组件的 render 方法获取组件返回的最新的 Virtual DOM 对象，再将 Virtual DOM 对象传递给 diff 方法，让 diff 方法找出差异，从而将差异更新到真实 DOM 对象中。</p> <p>在更新组件的过程中还要在不同阶段调用其不同的组件生命周期函数。</p> <p>在 diff 方法中判断要更新的 Virtual DOM 是否是组件，如果是组件又分为多种情况，新增 diffComponent 方法进行处理</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> virtualDOM<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 要更新的是组件</span>
  <span class="token comment">// 1) 组件本身的 virtualDOM 对象 通过它可以获取到组件最新的 props</span>
  <span class="token comment">// 2) 要更新的组件的实例对象 通过它可以调用组件的生命周期函数 可以更新组件的 props 属性 可以获取到组件返回的最新的 Virtual DOM</span>
  <span class="token comment">// 3) 要更新的 DOM 象 在更新组件时 需要在已有DOM对象的身上进行修改 实现DOM最小化操作 获取旧的 Virtual DOM 对象</span>
  <span class="token comment">// 4) 如果要更新的组件和旧组件不是同一个组件 要直接将组件返回的 Virtual DOM 显示在页面中 此时需要 container 做为父级容器</span>
  <span class="token function">diffComponent</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">,</span> oldComponent<span class="token punctuation">,</span> oldDOM<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在 diffComponent 方法中判断要更新的组件是未更新前的组件是否是同一个组件</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// diffComponent.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">diffComponent</span><span class="token punctuation">(</span>
  <span class="token parameter">virtualDOM<span class="token punctuation">,</span>
  oldComponent<span class="token punctuation">,</span>
  oldDOM<span class="token punctuation">,</span>
  container</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 判断要更新的组件和未更新的组件是否是同一个组件 只需要确定两者使用的是否是同一个构造函数就可以了</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSameComponent</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">,</span> oldComponent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 属同一个组件 做组件更新</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 不是同一个组件 直接将组件内容显示在页面中</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// virtualDOM.type 更新后的组件构造函数</span>
<span class="token comment">// oldComponent.constructor 未更新前的组件构造函数</span>
<span class="token comment">// 两者等价就表示是同一组件</span>
<span class="token keyword">function</span> <span class="token function">isSameComponent</span><span class="token punctuation">(</span><span class="token parameter">virtualDOM<span class="token punctuation">,</span> oldComponent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> oldComponent <span class="token operator">&amp;&amp;</span> virtualDOM<span class="token punctuation">.</span>type <span class="token operator">===</span> oldComponent<span class="token punctuation">.</span>constructor<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果不是同一个组件的话，就不需要执行更新组件的操作，直接将组件内容显示在页面中，替换原有内容</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// diffComponent.js</span>
<span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// 不是同一个组件 直接将组件内容显示在页面中</span>
  <span class="token comment">// 这里为 mountElement 方法新增了一个参数 oldDOM</span>
  <span class="token comment">// 作用是在将 DOM 对象插入到页面前 将页面中已存在的 DOM 对象删除 否则无论是旧DOM对象还是新DOM对象都会显示在页面中</span>
  <span class="token function">mountElement</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">,</span> container<span class="token punctuation">,</span> oldDOM<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在 mountNativeElement 方法中删除原有的旧 DOM 对象</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// mountNavtiveElement.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">mountNativeElement</span><span class="token punctuation">(</span><span class="token parameter">virtualDOM<span class="token punctuation">,</span> container<span class="token punctuation">,</span> oldDOM</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果旧的DOM对象存在 删除</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldDOM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">unmount</span><span class="token punctuation">(</span>oldDOM<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// unmount.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">unmount</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  node<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果是同一个组件的话，需要执行组件更新操作，需要调用组件生命周期函数</p> <p>先在 Component 类中添加生命周期函数，子类要使用的话直接覆盖就可以</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// Component.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token comment">// 生命周期函数</span>
  <span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">componentWillReceiveProps</span><span class="token punctuation">(</span><span class="token parameter">nextProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span><span class="token parameter">nextProps<span class="token punctuation">,</span> nextState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> nextProps <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">||</span> nextState <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">componentWillUpdate</span><span class="token punctuation">(</span><span class="token parameter">nextProps<span class="token punctuation">,</span> nextState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">componentDidUpdate</span><span class="token punctuation">(</span><span class="token parameter">prevProps<span class="token punctuation">,</span> preState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>新建 updateComponent 方法用于更新组件操作，并在 if 成立后调用</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// diffComponent.js</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSameComponent</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">,</span> oldComponent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 属同一个组件 做组件更新</span>
  <span class="token function">updateComponent</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">,</span> oldComponent<span class="token punctuation">,</span> oldDOM<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在 updateComponent 方法中调用组件的生命周期函数，更新组件获取最新 Virtual DOM，最终调用 diff 方法进行更新</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> diff <span class="token keyword">from</span> <span class="token string">&quot;./diff&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">updateComponent</span><span class="token punctuation">(</span>
  <span class="token parameter">virtualDOM<span class="token punctuation">,</span>
  oldComponent<span class="token punctuation">,</span>
  oldDOM<span class="token punctuation">,</span>
  container</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 生命周期函数</span>
  oldComponent<span class="token punctuation">.</span><span class="token function">componentWillReceiveProps</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token comment">// 调用 shouldComponentUpdate 生命周期函数判断是否要执行更新操作</span>
    oldComponent<span class="token punctuation">.</span><span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">.</span>props<span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 将未更新的 props 保存一份</span>
    <span class="token keyword">let</span> prevProps <span class="token operator">=</span> oldComponent<span class="token punctuation">.</span>props<span class="token punctuation">;</span>
    <span class="token comment">// 生命周期函数</span>
    oldComponent<span class="token punctuation">.</span><span class="token function">componentWillUpdate</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 更新组件的 props 属性 updateProps 方法定义在 Component 类型</span>
    oldComponent<span class="token punctuation">.</span><span class="token function">updateProps</span><span class="token punctuation">(</span>virtualDOM<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 因为组件的 props 已经更新 所以调用 render 方法获取最新的 Virtual DOM</span>
    <span class="token keyword">const</span> nextVirtualDOM <span class="token operator">=</span> oldComponent<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将组件实例对象挂载到 Virtual DOM 身上</span>
    nextVirtualDOM<span class="token punctuation">.</span>component <span class="token operator">=</span> oldComponent<span class="token punctuation">;</span>
    <span class="token comment">// 调用diff方法更新视图</span>
    <span class="token function">diff</span><span class="token punctuation">(</span>nextVirtualDOM<span class="token punctuation">,</span> container<span class="token punctuation">,</span> oldDOM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 生命周期函数</span>
    oldComponent<span class="token punctuation">.</span><span class="token function">componentDidUpdate</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// Component.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token function">updateProps</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">=</span> props<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/learn-note/react/tiny-react/渲染组件.html" class="prev">
        8. 渲染组件
      </a></span> <span class="next"><a href="/learn-note/react/tiny-react/ref 属性.html">
        10. ref 属性
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/learn-note/assets/js/app.e5c60dd5.js" defer></script><script src="/learn-note/assets/js/2.923ebc4c.js" defer></script><script src="/learn-note/assets/js/6.28078a48.js" defer></script>
  </body>
</html>
